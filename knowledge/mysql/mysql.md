## MySQL 执行流程
- Server层
  * 连接器：用来处理客户端连接请求，需要经过 TCP 三次握手，校验用户名和密码以及权限。
  * 查询缓存：用来缓存查询结果，但是在 MySQL 8.0 版本中已经被废弃。
  * 解析器：用来分析SQL语句，识别SQL语句的语法是否正确，包括词法分析和语法分析。
  * 预处理器：检查表和字段是否存在，以及是否有权限操作。将 * 替换为具体字段。
  * 优化器：用来优化SQL语句，选择最优的执行方案
  * 执行器：用来执行SQL语句，操作数据库
- 存储引擎层
  * 存储引擎：用来存储数据，提供数据的增删改查操作，支持 MyISAM、InnoDB、Memory 等存储引擎。
    * 存储引擎是基于表的，每个表都可以选择不同的存储引擎。

### MyISAM 和 InnoDB 的区别
| 特性   | MyISAM              | InnoDB                         |
|------|---------------------|--------------------------------|
| 事务   | 不支持                 | 支持（undo log / redo log / MVCC） |
| 行级锁  | 不支持                 | 支持                             |
| 外键   | 不支持                 | 支持                             |
| 崩溃恢复 | 不支持                 | 支持（**为什么 redo log 可以？**）       |
| 缓存策略 | 使用 Key Cache，只缓存索引页 | 使用 Buffer Pool，缓存索引页和数据页       |

## 表空间文件结构
* 行（row）：表中的每一行数据是以行的形式存储的。
* 页（page）：InnoDB 存储引擎中的最小存储单位，默认大小为 16KB。
* 区（extent）：物理上由连续的页组成，默认大小为 1MB，包含 64 个连续页（优化磁盘顺序读）。
* 段（segment）：表空间由各个段组成，包括数据段（B+ 树叶子结点）、索引段（B+ 树非叶子结点）、回滚段（undo log）等。

### 行格式
* Redundant：MySQL 5.0 之前的默认格式，冗余格式，不支持行级压缩，不支持大字段。
* Compact：MySQL 5.1 默认格式，紧凑格式，支持行级压缩，支持大字段。
* Dynamic：MySQL 5.7 默认格式，基于 Compact 格式改进。
* Compressed：支持行级压缩，基于 Compact 格式改进。

### Compact 行格式
* 变长字段长度列表：**逆序存储**每个变长字段的长度，用于定位变长字段的位置。
* NULL 值列表
<img src="/knowledge/assets/mysql/compact-row.png" width="600">

#### 为什么变长字段长度列表是逆序存储的？
* 行记录指针指向头信息字段和真实数据之间的位置，向前可以得到头信息字段，向右可以得到真实数据。
* 位置靠前的记录和其对应的长度字段可以同时在一个 CPU Cache Line 中，提高 Cache 命中率。
* 同理，NULL 字段也要逆序存放。
