## HTTP 和 HTTPS 的区别
| 特性   | HTTP     | HTTPS           |
|------|----------|-----------------|
| 安全性  | 明文传输     | 采用 SSL/TLS 加密传输 |
| 端口   | 80       | 443             |
| 请求前缀 | http     | https           |
| 连接建立 | TCP 三次握手 | 还需要 TLS 四次握手    |

#### HTTPS 解决了哪些问题？
* 窃听问题：通过**混合加密**，使得第三方无法窃听。
* 篡改问题：通过**摘要算法**，保证数据完整性。
* 冒充问题：将服务器的公钥放入证书中，保证通信双方的身份。

## 数字证书
### 数字证书包含的内容
公钥、证书持有者、CA、证书有效期、CA 对此证书的数字签名算法、证书序列号等。
### 证书签发流程
* 首先 CA 会对证书持有者的公钥、颁发者、有效期等信息进行哈希，得到摘要。
* CA 使用自己的私钥对摘要进行加密，得到数字签名。
* CA 将数字签名和证书持有者的公钥等信息一起打包，形成证书。
### 证书验证流程
* 客户端根据 CA 使用的数字签名算法，对证书内容进行哈希，得到摘要 A。
* 客户端通过浏览器或操作系统集成的 CA 公钥，对证书中的数字签名进行解密，得到摘要 B。
* 客户端比较摘要 A 和摘要 B，若相同，则证书有效。
### 证书信任链
为了确保根证书的安全性，将根证书隔离地越严格越好。

## HTTPS 加密过程
* 客户端向服务器发送 HTTPS 请求。
* 服务器返回证书，证书中包含公钥。
* 客户端验证证书的合法性，若验证通过，会生成一个用于会话的对称秘钥
* 客户端使用服务器的公钥对对称秘钥进行加密，发送给服务器。
* 服务器使用私钥对对称秘钥进行解密，得到对称秘钥。
* 服务端和客户端使用对称秘钥进行加密通信。
### RSA 握手过程
不支持前向保密，一旦服务端的私钥泄露，攻击者可以解密所有的通信。
#### TLS 第一次握手
* Client Hello：客户端将使用的 TLS 版本号、 ClientRandom、支持的加密算法、支持的压缩算法等信息发送给服务器。
#### TLS 第二次握手
* Server Hello：服务器将 ServerRandom、选择的加密算法等信息发送给客户端。
* Server Certificate：服务器发送数字证书给客户端。
#### TLS 第三次握手
* 验证服务端证书的合法性。
* Client Key Exchange：客户端生成一个新的随机数 pre-master，使用服务端的公钥加密后发送给服务端。
* 至此，**客户端和服务端都有了三个随机数，ClientRandom、ServerRandom 和 pre-master**。
* 客户端和服务端使用这三个随机数生成一个对称秘钥 master，用于后续通信。
* Change Cipher Spec：客户端通知服务端，后续通信将使用 master 作为对称秘钥。
* Finished：客户端将之前所发送的数据进行摘要，发送给服务端，用于验证通信的完整性。
#### TLS 第四次握手
* Change Cipher Spec：服务端通知客户端，后续通信将使用 master 作为对称秘钥。
* Finished：服务端将之前所发送的数据进行摘要，发送给客户端，用于验证通信的完整性。
### ECDHE 握手过程
* ECDHE 使用临时的公钥，不会泄露长期的私钥，支持前向保密。
* 在 TLS 第四次握手前，就可以加密通信了（原因不明），而 RSA 需要等到第四次握手后才能加密通信，被称为 **TLS False Start**。
#### TLS 第一次握手
* Client Hello：同 RSA 第一次握手。
#### TLS 第二次握手
* Server Hello：同 RSA 第二次握手。
* Server Certificate：同 RSA 第二次握手。
* 选择椭圆曲线（可知 G 点），生成随机数作为椭圆曲线的私钥，根据 G 点和私钥计算出公钥。
* Server Key Exchange：服务端发送临时公钥给客户端，公钥会使用 RSA 摘要防止篡改。
* 至此，**客户端和服务端共享了，ClientRandom、ServerRandom、椭圆曲线、G 点、椭圆曲线公钥**。
#### TLS 第三次握手
* Client Key Exchange：客户端生成一个随机数，根据椭圆曲线和 G 点计算出公钥，发送给服务端。
* 此时双方都有了临时的公钥，可以生成对称秘钥 master。
* Change Cipher Spec：同 RSA 第三次握手。
* Encrypted Handshake Message：客户端将之前所发送的数据进行摘要，发送给服务端，用于验证通信的完整性。
#### TLS 第四次握手(同 RSA 第四次握手)

## 参考链接
[小林 Coding](https://xiaolincoding.com/network/2_http/https_rsa.html#tls-%E7%AC%AC%E5%9B%9B%E6%AC%A1%E6%8F%A1%E6%89%8B)